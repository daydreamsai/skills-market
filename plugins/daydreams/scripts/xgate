#!/usr/bin/env bash
# xgate - CLI for querying xgate-server API
# Usage: xgate <command> [options]

set -e

XGATE_URL="${XGATE_URL:-https://api.xgate.run}"

usage() {
    cat << EOF
xgate - Query xgate-server API

Usage: xgate <command> [options]

Commands:
  health                        Check server health
  services [options]            Search services
  service <id>                  Get service by ID
  agents [options]              Search agents
  transfers [options]           Query token transfers
  resource-transfers <addr>     Get transfers for resource address

Service Options:
  -q, --query <text>           Search query
  -n, --network <networks>     Comma-separated networks (ethereum,base)
  -a, --asset <assets>         Comma-separated assets (USDC,ETH)
  -l, --limit <n>              Results limit (default: 10)
  -o, --offset <n>             Pagination offset
  --debug                      Enable debug mode

Agent Options:
  -q, --query <text>           Search query
  -c, --chain <id>             Chain ID
  -p, --protocols <list>       Comma-separated protocols (MCP,A2A)
  --min-score <n>              Minimum reputation score (0-1)
  --status <status>            Validation status (pending,completed,expired,revoked)
  -l, --limit <n>              Results limit (default: 10)
  -o, --offset <n>             Pagination offset
  --debug                      Enable debug mode

Transfer Options:
  -c, --chain <id>             Chain ID (required)
  -f, --from <addr>            From address
  -t, --to <addr>              To address
  -w, --wallet <addr>          Wallet address
  --facilitator <id>           Facilitator ID
  -l, --limit <n>              Results limit (default: 100)
  --totals                     Include value totals

Examples:
  xgate health
  xgate services -q "token" -n ethereum
  xgate agents -p MCP --min-score 0.8
  xgate transfers -c 8453 --totals
  xgate resource-transfers 0x1234... -c 1

Environment:
  XGATE_URL    API base URL (default: https://api.xgate.run)
EOF
}

health() {
    curl -s "$XGATE_URL/health" | jq
}

services() {
    local query="" network="" asset="" limit=10 offset=0 debug=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            -q|--query) query="$2"; shift 2 ;;
            -n|--network) network="$2"; shift 2 ;;
            -a|--asset) asset="$2"; shift 2 ;;
            -l|--limit) limit="$2"; shift 2 ;;
            -o|--offset) offset="$2"; shift 2 ;;
            --debug) debug="true"; shift ;;
            *) echo "Unknown option: $1"; exit 1 ;;
        esac
    done

    local url="$XGATE_URL/services/?limit=$limit&offset=$offset"
    [[ -n "$query" ]] && url+="&q=$(printf '%s' "$query" | jq -sRr @uri)"
    [[ -n "$network" ]] && url+="&network=$network"
    [[ -n "$asset" ]] && url+="&asset=$asset"
    [[ -n "$debug" ]] && url+="&debug=true"

    curl -s "$url" | jq
}

service() {
    local id="$1"
    [[ -z "$id" ]] && { echo "Error: service ID required"; exit 1; }
    curl -s "$XGATE_URL/services/$id" | jq
}

agents() {
    local query="" chain="" protocols="" min_score="" status="" limit=10 offset=0 debug=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            -q|--query) query="$2"; shift 2 ;;
            -c|--chain) chain="$2"; shift 2 ;;
            -p|--protocols) protocols="$2"; shift 2 ;;
            --min-score) min_score="$2"; shift 2 ;;
            --status) status="$2"; shift 2 ;;
            -l|--limit) limit="$2"; shift 2 ;;
            -o|--offset) offset="$2"; shift 2 ;;
            --debug) debug="true"; shift ;;
            *) echo "Unknown option: $1"; exit 1 ;;
        esac
    done

    local url="$XGATE_URL/agents/?limit=$limit&offset=$offset"
    [[ -n "$query" ]] && url+="&q=$(printf '%s' "$query" | jq -sRr @uri)"
    [[ -n "$chain" ]] && url+="&chain_id=$chain"
    [[ -n "$protocols" ]] && url+="&protocols=$protocols"
    [[ -n "$min_score" ]] && url+="&min_score=$min_score"
    [[ -n "$status" ]] && url+="&validation_status=$status"
    [[ -n "$debug" ]] && url+="&debug=true"

    curl -s "$url" | jq
}

transfers() {
    local chain="" from="" to="" wallet="" facilitator="" limit=100 totals=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            -c|--chain) chain="$2"; shift 2 ;;
            -f|--from) from="$2"; shift 2 ;;
            -t|--to) to="$2"; shift 2 ;;
            -w|--wallet) wallet="$2"; shift 2 ;;
            --facilitator) facilitator="$2"; shift 2 ;;
            -l|--limit) limit="$2"; shift 2 ;;
            --totals) totals="true"; shift ;;
            *) echo "Unknown option: $1"; exit 1 ;;
        esac
    done

    local url="$XGATE_URL/onchain/token-transfers?limit=$limit"
    [[ -n "$chain" ]] && url+="&chain_id=$chain"
    [[ -n "$from" ]] && url+="&from_address=$from"
    [[ -n "$to" ]] && url+="&to_address=$to"
    [[ -n "$wallet" ]] && url+="&wallet_address=$wallet"
    [[ -n "$facilitator" ]] && url+="&facilitator_id=$facilitator"
    [[ -n "$totals" ]] && url+="&include_totals=true"

    curl -s "$url" | jq
}

resource_transfers() {
    local address="$1"; shift
    local chain="" limit=100

    [[ -z "$address" ]] && { echo "Error: address required"; exit 1; }

    while [[ $# -gt 0 ]]; do
        case $1 in
            -c|--chain) chain="$2"; shift 2 ;;
            -l|--limit) limit="$2"; shift 2 ;;
            *) echo "Unknown option: $1"; exit 1 ;;
        esac
    done

    [[ -z "$chain" ]] && { echo "Error: chain ID required (-c)"; exit 1; }

    curl -s "$XGATE_URL/services/resource/$address/transfers?chain_id=$chain&limit=$limit" | jq
}

# Main
case "${1:-}" in
    health) health ;;
    services) shift; services "$@" ;;
    service) shift; service "$@" ;;
    agents) shift; agents "$@" ;;
    transfers) shift; transfers "$@" ;;
    resource-transfers) shift; resource_transfers "$@" ;;
    -h|--help|help|"") usage ;;
    *) echo "Unknown command: $1"; usage; exit 1 ;;
esac
